<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
        integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
        crossorigin="" />
    <link rel="stylesheet" type="text/css" href="Heatmap_page.css">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="../lib/leaflet/leaflet.css" />
    <script type="text/javascript" src="../lib/leaflet/leaflet.js"></script>
    <script type="text/javascript" src="../heatmap.js/build/heatmap.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script type="text/javascript" src="Heatmap_page.js"></script>
    <script type="text/javascript" src="../Folkmangd.json"></script>
    <script type="text/javascript" src="../heatmap.js/plugins/leaflet-heatmap/leaflet-heatmap.js"></script>


</head>

<body>
    <httpProtocol>
        <customHeaders>
            <add name="Access-Control-Allow-Origin" value="*" />
        </customHeaders>
    </httpProtocol>
    <div id="Main">
        <!-- First map-->
        <div class="Map">
            <p class="MapHeader">Map Location Based!</p>
            <div class="MapIllustration" id="mapOneID"></div>
        </div>
        <!-- Option Menu-->
        <div class="OptionMenu">
            <p class="OptionHeader" id="testid">Option Menu</p>
            <!--Folkmangd button-->
            <div class="OptionButton">
                <p class="OptionButtonHeader">Goto Location</p>
                <select class="OptionMainDropdown" onchange="selectedID = this.value" name="Landsting" id="Landsting">

                </select>
               <!-- <select class="OptionMainDropdown" onchange="selectedYear = this.value" name="LandYear" id="LandYear">

                </select> -->
                <button onclick="gotoPos();">Goto</button>
                <button onclick="changeHeatMapData();">Render heatMap</button>
            </div>
        </div>
    </div>
    <script>

        //Getting the json file and doing it useable
        var staticUrl = 'https://raw.githubusercontent.com/a18lukto/Examensarbete/main/Folkmangd.json';
        var dataValues;
        $.getJSON(staticUrl, function (fejs) {
            dataValues = JSON.parse(JSON.stringify(fejs));
        });

        var years = [
            {id: "1", IDyear: "2020"},{id: "2", IDyear: "2019"},{id: "3", IDyear: "2018"},{id: "4", IDyear: "2017"},{id: "5", IDyear: "2016"},{IDyear: "2015"},{IDyear: "2014"},{IDyear: "2013"},{IDyear: "2012"},{IDyear: "2011"},
            {IDyear: "2011"},{IDyear: "2010"},{IDyear: "2009"},{IDyear: "2008"},{IDyear: "2007"},{IDyear: "2006"},{IDyear: "2005"},{IDyear: "2004"},{IDyear: "2003"},{IDyear: "2002"},
            {IDyear: "2001"},{IDyear: "2000"},{IDyear: "1999"},{IDyear: "1998"},{IDyear: "1997"},{IDyear: "1996"},{IDyear: "1995"},{IDyear: "1994"},{IDyear: "1993"},{IDyear: "1992"},
            {IDyear: "1991"},{IDyear: "1990"},{IDyear: "1989"},{IDyear: "1988"},{IDyear: "1987"},{IDyear: "1986"},{IDyear: "1985"},{IDyear: "1984"},{IDyear: "1983"},{IDyear: "1982"},
            {IDyear: "1981"},{IDyear: "1980"},{IDyear: "1979"},{IDyear: "1978"},{IDyear: "1977"},{IDyear: "1976"},{IDyear: "1975"},{IDyear: "1974"},{IDyear: "1973"},{IDyear: "1972"},
            {IDyear: "1971"},{IDyear: "1970"},{IDyear: "1969"},{IDyear: "1968"},
    ];
        // Locations data
        var locations = [
        { id: "01", namn: "Stockholms län", lat: 59.334415, lng: 18.110103 },
        { id: "03", namn: "Uppsala län", lat: 60.122902, lng: 17.750488 },
        { id: "04", namn: "Södermankands län", lat: 59.029457, lng: 16.764816 },
        { id: "05", namn: "Östergötlands län", lat: 58.34619, lng: 16.15167 },
        { id: "06", namn: "Jönköping län", lat: 57.423412 , lng: 14.34349 },
        { id: "07", namn: "Kronobergs län", lat: 56.86357 , lng: 14.578271 },
        { id: "08", namn: "Kalmar län", lat:  57.251823 , lng: 16.308237 },
        { id: "09", namn: "Gotlands län", lat: 57.598454 , lng: 18.732735 },
        { id: "10", namn: "Blekinge län", lat: 56.207233 , lng: 15.158815 },
        { id: "12", namn: "Skåne län", lat: 55.95244 , lng: 13.482019 },
        { id: "13", namn: "Hallands län", lat:  57.071297 , lng: 12.717986 },
        { id: "14", namn: "Västra Götalands län", lat: 58.253223, lng: 12.244518 },
        { id: "17", namn: "Värmlands län", lat: 59.69761 , lng:  13.069618},
        { id: "18", namn: "Örebro län", lat: 59.294216  , lng: 15.041704 },
        { id: "19", namn: "Västmanlands län", lat: 59.781254 , lng: 16.134008 },
        { id: "20", namn: "Dalarnas län", lat: 60.782745 , lng:  14.769239 },
        { id: "21", namn: "Gävleborgs län", lat: 61.345898 , lng: 16.73273 },
        { id: "22", namn: "Västernorrlands län", lat: 62.924004 , lng: 17.836418 },
        { id: "23", namn: "Jämtlands län", lat: 63.353344 , lng: 14.7706175 },
        { id: "24", namn: "Västerbottens län", lat: 64.38316 , lng:  19.472322 },
        { id: "25", namn: "Norrbottens län", lat:  66.432686 , lng: 22.301443 },
        
        ];

        var selectedID;
        var year
        var selectedYear;
        //Data used for heatmap
        var testData = {
            max: 1000000,
            data: []
        };

        //This will add data from the json and change the map to fit according to what data you want to use
        function changeHeatMapData() {
            var dataByYear = getDataByYear("2020");
            dataByYear[0].forEach(item => {
                var temp2 = [];
                var temp2 = locations.filter(location => {
                    return item.key[0] == location.id;
                })
               /* var temp3 = [];
                var temp3 = years.filter(year => {
                    return item.key[0] == year.id;
                })
                */
                if(temp2.length != 0){
                console.log(temp2)
                testData.data.push({
                    lat: temp2[0].lat,
                    lng: temp2[0].lng,
                    count: (item.values[0]/100000)
                });
                }
            })
            heatmapLayer.setData(testData);
        }

        //Fetching data from json file which have the right year
        function getDataByYear(ChoosenYear) {
            var data = dataValues[0].data;
            var newData = [];
            newData.push(data.filter(function (x) {
                return x.key[2] == ChoosenYear;
            }));
            return newData;
        }

        //Changes the position on the map according to choosen location
        function gotoPos() {
            var location = locations.filter(location => location.id == selectedID)[0];
            //var year = years.filter(year => year.id == selectedYear)[0];
            map.panTo(new L.LatLng(location.lat, location.lng));
        }

        //Creating options to choose from using the locations provided in array above
        function getOptions() {
            var string = "<option value='' disabled selected hidden>Välj landsting</option>";
            locations.forEach(location => string += "<option value='" + location.id + "'>" + location.namn + "</option>")
            return string;
        }
        /*
        function getYears() {
            var string = "<option value='' disabled selected hidden>Välj år</option>";
            years.forEach(year => string += "<option value='" + years.id + "'>" + years.id + "</option>")
            return string;
        }
        */
        //document.getElementById('LandYear').innerHTML = getYears();
        document.getElementById('Landsting').innerHTML = getOptions();

        //Maplayer
        var baseLayer = L.tileLayer(
            'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '...',
            maxZoom: 18
        }
        );

        //Config for the heatmap
        var cfg = {
            "radius": 0.35, // radius should be small ONLY if scaleRadius is true (or small radius is intended) | if scaleRadius is false it will be the constant radius used in pixels
            "maxOpacity": .5,   //How se trough the heatmap should be
            "scaleRadius": true, // scales the radius based on map zoom  
            "useLocalExtrema": true, // if set to false the heatmap uses the global maximum for colorization | if activated: uses the data maximum within the current map boundaries | (there will always be a red spot with useLocalExtremas true)
            latField: 'lat', // which field name in your data represents the latitude - default "lat"
            lngField: 'lng', // which field name in your data represents the longitude - default "lng"
            valueField: 'count' // which field name in your data represents the data value - default "value"
        };

        //Varibles for map creation
        var heatmapLayer = new HeatmapOverlay(cfg);
        var dataValues;

        //To create and generate the first map
        var map = new L.Map('mapOneID', {
            center: new L.LatLng(60.122902, 17.750488),
            zoom: 8,
            layers: [baseLayer, heatmapLayer]
        });

    </script>
</body>

</html>